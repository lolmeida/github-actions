# ==============================================
# WORKFLOW: create-app-entry.yml - Regista Apps
# ==============================================

name: Register Application

on:
  workflow_call:
    inputs:
      app_name:
        description: 'Application name'
        required: true
        type: string
      app_ingress:
        description: 'Application URL'
        required: true
        type: string
      app_description:
        description: 'Application description'
        required: true
        type: string
      app_icon:
        description: 'App icon URL (optional)'
        required: false
        type: string
        default: ''
      is_active:
        description: 'Is application active?'
        required: false
        type: boolean
        default: true
      is_enabled:
        description: 'Is application enabled?'
        required: false
        type: boolean
        default: true
      api_base_url:
        description: 'Base URL for the deployment API (e.g., https://k8s-be.lolmeida.com)'
        required: false
        type: string
        default: 'https://k8s-be.lolmeida.com'
      keycloak_url:
        description: 'Keycloak base URL (e.g., https://keycloak.lolmeida.com)'
        required: false
        type: string
        default: 'https://keycloak.lolmeida.com'
      realm:
        description: 'Keycloak realm'
        required: false
        type: string
        default: 'peah'
      client_id:
        description: 'Keycloak client ID'
        required: false
        type: string
        default: 'kubernetes-backend'
    secrets:
      KEYCLOAK_CLIENT_SECRET:
        required: true

jobs:
  register-app:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with Keycloak
        id: auth
        shell: bash
        env:
          KEYCLOAK_URL: ${{ inputs.keycloak_url }}
          REALM: ${{ inputs.realm }}
          CLIENT_ID: ${{ inputs.client_id }}
          CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
        run: |
          TOKEN_URL="${KEYCLOAK_URL}/realms/${REALM}/protocol/openid-connect/token"
          echo "Authenticating against $TOKEN_URL"

          if [[ -z "$CLIENT_SECRET" ]]; then
            echo "KEYCLOAK_CLIENT_SECRET is empty!"
            exit 1
          fi

          TOKEN_RESPONSE=$(curl -s -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=${CLIENT_ID}" \
            -d "client_secret=${CLIENT_SECRET}" \
            --max-time 30 \
            -w "HTTP_STATUS:%{http_code}")

          HTTP_STATUS=$(echo "$TOKEN_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | tail -1 | cut -d: -f2)
          RESPONSE_BODY=$(echo "$TOKEN_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')

          if [[ "$HTTP_STATUS" != "200" ]]; then
            echo "Authentication failed (HTTP $HTTP_STATUS)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi

          TOKEN=$(echo "$RESPONSE_BODY" | jq -r '.access_token')

          if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
            echo "No access_token found in response"
            exit 1
          fi

          EXPIRES_IN=$(echo "$RESPONSE_BODY" | jq -r '.expires_in')
          echo "Authentication successful (token expires in ${EXPIRES_IN}s)"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Test API Access
        shell: bash
        env:
          TOKEN: ${{ steps.auth.outputs.token }}
          API_BASE_URL: ${{ inputs.api_base_url }}
        run: |
          echo "Testing API endpoint: ${API_BASE_URL}/deployed-apps"

          TEST_RESPONSE=$(curl -s -X GET "${API_BASE_URL}/deployed-apps" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/json" \
            -w "HTTP_STATUS:%{http_code}" \
            --max-time 30)

          HTTP_STATUS=$(echo "$TEST_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | tail -1 | cut -d: -f2)

          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "API access OK"
          elif [[ "$HTTP_STATUS" == "401" ]]; then
            echo "API returned 401 - Token not accepted"
            echo "Check if API is configured to accept Keycloak tokens"
            exit 1
          else
            echo "API returned HTTP $HTTP_STATUS"
          fi

      - name: Register Application
        id: register
        shell: bash
        env:
          APP_NAME: ${{ inputs.app_name }}
          APP_URL: ${{ inputs.app_ingress }}
          APP_DESCRIPTION: ${{ inputs.app_description }}
          APP_ICON: ${{ inputs.app_icon }}
          IS_ACTIVE: ${{ inputs.is_active }}
          IS_ENABLED: ${{ inputs.is_enabled }}
          TOKEN: ${{ steps.auth.outputs.token }}
          API_BASE_URL: ${{ inputs.api_base_url }}
        run: |
          echo "Registering application:"
          echo "  Name: $APP_NAME"
          echo "  URL: $APP_URL"
          echo "  Description: $APP_DESCRIPTION"

          # Default icon if empty
          if [[ -z "$APP_ICON" ]]; then
            APP_NAME_ENCODED=$(echo "$APP_NAME" | sed 's/ /%20/g')
            APP_ICON="https://placehold.co/600x400/white/gray?text=${APP_NAME_ENCODED}"
          fi

          REGISTER_PAYLOAD=$(jq -n \
            --arg name "$APP_NAME" \
            --arg url "$APP_URL" \
            --arg description "$APP_DESCRIPTION" \
            --arg icon "$APP_ICON" \
            --argjson isActive $IS_ACTIVE \
            --argjson isEnabled $IS_ENABLED \
            '{name: $name, url: $url, description: $description, icon: $icon, isActive: $isActive, isEnabled: $isEnabled}')

          REGISTER_RESPONSE=$(curl -s -X POST "${API_BASE_URL}/deployed-apps" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "$REGISTER_PAYLOAD" \
            --max-time 30 \
            -w "HTTP_STATUS:%{http_code}")

          HTTP_STATUS=$(echo "$REGISTER_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
          RESPONSE_BODY=$(echo "$REGISTER_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')

          echo "HTTP Status: $HTTP_STATUS"

          case "$HTTP_STATUS" in
            200|201)
              APP_ID=$(echo "$RESPONSE_BODY" | jq -r '.id // .app_id // "unknown"')
              echo "App registered successfully! ID: $APP_ID"
              echo "status=success" >> $GITHUB_OUTPUT
              echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
              ;;
            409)
              echo "App already exists"
              echo "status=already-exists" >> $GITHUB_OUTPUT
              ;;
            401)
              echo "Registration failed - Unauthorized"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
              ;;
            403)
              echo "Registration failed - Forbidden"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
              ;;
            *)
              echo "Registration failed with HTTP $HTTP_STATUS"
              echo "Response: $RESPONSE_BODY"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac
