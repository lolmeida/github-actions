name: Docker Jib Push (Reusable)

on:
  workflow_call:
    inputs:
      java_version:
        description: 'Java version'
        required: false
        type: string
        default: '21'
      java_distribution:
        description: 'Java distribution'
        required: false
        type: string
        default: 'temurin'
      maven_args:
        description: 'Additional Maven arguments'
        required: false
        type: string
        default: ''
      image_name:
        description: 'Docker image name (optional, uses project artifactId if not provided)'
        required: false
        type: string
        default: ''
      registry:
        description: 'Docker registry'
        required: false
        type: string
        default: 'docker.io'
      skip_tests:
        description: 'Skip running tests'
        required: false
        type: boolean
        default: false
      maven_profiles:
        description: 'Maven profiles to activate'
        required: false
        type: string
        default: ''
      working_directory:
        description: 'Working directory'
        required: false
        type: string
        default: '.'
    secrets:
      DOCKER_HUB_USER:
        required: true
      DOCKER_HUB_TOKEN:
        required: true
    outputs:
      image_name:
        description: 'Built image name'
        value: ${{ jobs.build-and-push.outputs.image_name }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.image-info.outputs.image_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ inputs.java_distribution }}
          java-version: ${{ inputs.java_version }}
          cache: 'maven'

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push with Jib
        working-directory: ${{ inputs.working_directory }}
        run: |
          ARGS=("-B" "-ntp" "package")

          [[ "${SKIP_TESTS}" == "true" ]] && ARGS+=("-DskipTests")
          [[ -n "${PROFILES}" ]] && ARGS+=("-P${PROFILES}")
          [[ -n "${IMAGE_NAME}" ]] && ARGS+=("-Dquarkus.container-image.name=${IMAGE_NAME}")
          [[ -n "${MAVEN_ARGS}" ]] && ARGS+=(${MAVEN_ARGS})

          ARGS+=("-Dquarkus.container-image.build=true")
          ARGS+=("-Dquarkus.container-image.push=true")
          ARGS+=("-Dquarkus.container-image.registry=${REGISTRY}")
          ARGS+=("-Dquarkus.container-image.group=${DOCKER_USER}")

          ./mvnw "${ARGS[@]}"
        env:
          SKIP_TESTS: ${{ inputs.skip_tests }}
          PROFILES: ${{ inputs.maven_profiles }}
          IMAGE_NAME: ${{ inputs.image_name }}
          MAVEN_ARGS: ${{ inputs.maven_args }}
          REGISTRY: ${{ inputs.registry }}
          DOCKER_USER: ${{ secrets.DOCKER_HUB_USER }}

      - name: Output image info
        id: image-info
        working-directory: ${{ inputs.working_directory }}
        run: |
          if [[ -n "${IMAGE_NAME}" ]]; then
            NAME="${IMAGE_NAME}"
          elif [[ -f "pom.xml" ]]; then
            NAME=$(./mvnw help:evaluate -Dexpression=project.artifactId -q -DforceStdout 2>/dev/null || basename "$(pwd)")
          else
            NAME=$(basename "$(pwd)")
          fi
          echo "image_name=${REGISTRY}/${DOCKER_USER}/${NAME}:latest" >> $GITHUB_OUTPUT
        env:
          IMAGE_NAME: ${{ inputs.image_name }}
          REGISTRY: ${{ inputs.registry }}
          DOCKER_USER: ${{ secrets.DOCKER_HUB_USER }}
