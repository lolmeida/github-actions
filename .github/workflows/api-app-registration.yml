on:
  workflow_call:
    inputs:
      app_name:
        description: 'Nome da aplicação'
        required: true
        type: string
      api_base_url:
        description: 'Base URL da API'
        required: true
        type: string
      app_url:
        description: 'Callback / redirect URL'
        required: true
        type: string
      app_icon:
        description: 'URL do ícone da aplicação'
        required: false
        type: string
      isActive:
        description: 'Se a aplicação está ativa'
        required: false
        default: true
        type: boolean
      isEnabled:
        description: 'Se a aplicação está habilitada'
        required: false
        default: true
        type: boolean
      app_description:
        description: 'Descrição da aplicação'
        required: false
        type: string
      dry_run:
        description: 'Se true, apenas simula o registo'
        required: false
        default: false
        type: boolean
      image_name:
        description: 'Nome da imagem Docker gerada no build-and-push'
        required: false
        type: string
    secrets:
      API_USERNAME:
        required: true
      API_PASSWORD:
        required: true

jobs:
  register:
    runs-on: ubuntu-latest
    steps:
      - name: Register app via API
        run: |
          echo "App: ${{ inputs.app_name }}"
          echo "Base URL: ${{ inputs.api_base_url }}"
          echo "App URL: ${{ inputs.app_url }}"
          echo "Description: ${{ inputs.app_description }}"
          echo "Dry run: ${{ inputs.dry_run }}"
          echo "Image: ${{ inputs.image_name }}"
          curl -u "${{ secrets.API_USERNAME }}:${{ secrets.API_PASSWORD }}" \
            -X POST "${{ inputs.api_base_url }}/register" \
            -H "Content-Type: application/json" \
            -d "{
              \"name\": \"${{ inputs.app_name }}\",
              \"url\": \"${{ inputs.app_url }}\",
              \"description\": \"${{ inputs.app_description }}\",
              \"icon\": \"${{ inputs.app_icon }}\",
              \"isEnabled\": \"${{ inputs.isEnabled }}\",
              \"isActive\": \"${{ inputs.isActive }}\"
            }"
